
<!--
  This Behavior Tree replans the global path periodically at 1 Hz through an array of poses continuously
   and it also has recovery actions specific to planning / control as well as general system issues.
-->
<root BTCPP_format="4" main_tree_to_execute="MainTree">
  <BehaviorTree ID="MainTree">
    <Sequence>
      <ProgressCheckerSelector selected_progress_checker="{selected_progress_checker}" default_progress_checker="progress_checker" topic_name="progress_checker_selector"/>
      <GoalCheckerSelector selected_goal_checker="{selected_goal_checker}" default_goal_checker="general_goal_checker" topic_name="goal_checker_selector"/>
      <ControllerSelector selected_controller="{selected_controller}" default_controller="FollowPath" topic_name="controller_selector"/>
      <PlannerSelector selected_planner="{selected_planner}" default_planner="GridBased" topic_name="planner_selector"/>
      <ComputePathThroughPoses goals="{goals}" path="{path}" planner_id="{selected_planner}" error_code_id="{compute_path_error_code}" error_msg="{compute_path_error_msg}"/>
      <GetCurrentPose current_pose="{current_pose}"/>
      <PublishGoals input_goals="{goals}" topic_name= "debug_goals"/> 
      <!-- <SetBlackboard output_key="last_pose" value="{initial_pose}"/> -->
      <SetBlackboard output_key="stopped" value="false"/>

      <PipelineSequence name="NavigateLoop">
       
        <RateController hz="1.0">
          <ForceSuccess>
            <Sequence>
              <ScriptCondition code="stopped == false"/>
              <RemovePassedGoals input_goals="{goals}" output_goals="{goals}" nb_goals_to_consider = "10" radius="0.5" input_waypoint_statuses="{waypoint_statuses}" output_waypoint_statuses="{waypoint_statuses}"/>
              <TruncatePathLocal input_path="{path}" pose="{current_pose}" output_path="{path_local}" distance_forward="1.0" distance_backward="0.0" robot_frame="base_link"/>
              <GetPoseFromPath path="{path_local}" index="-1" pose="{goal}"/>
              <AppendGoalPoseToGoals goal_pose="{goal}" input_goals="{goal_poses}" output_goals="{goal_poses}"/>
              <PublishGoals input_goals="{goal_poses}" topic_name= "goal_poses"/> 
            </Sequence>
          </ForceSuccess>
        </RateController>
        
        <RetryUntilSuccessful num_attempts="1000">
          <ForceFailure>
            <Fallback name="FollowPathAndAvoidObstacles">
              <ReactiveSequence>
                <GetCurrentPose current_pose="{current_pose}"/>
                <IsPathValid path="{path_local}" max_cost="254"/>
                <FollowPath path="{path_local}"
                            controller_id="{selected_controller}"
                            error_code_id="{follow_path_error_code}"/>
              </ReactiveSequence>
              <Sequence>
                <SetBlackboard output_key="stopped" value="true"/>
                <!-- <Wait wait_duration="1.0"/> -->
                <RetryUntilSuccessful num_attempts="1000"> 
                  <Sequence name="Replan">
                    <RemoveInCollisionGoals input_goals="{goals}" output_goals="{goals}" nb_goals_to_consider = "5" cost_threshold="253.0" use_footprint="true" service_name="/global_costmap/get_cost_global_costmap" input_waypoint_statuses="{waypoint_statuses}" output_waypoint_statuses="{waypoint_statuses}" />
                    <GetNextFewGoals num_goals="5" input_goals="{goals}" output_goals="{planning_goals}"/>
                    <ComputePathThroughPoses goals="{planning_goals}" path="{avoid_path}"
                                    planner_id="{selected_planner}"
                                    error_code_id="{compute_path_error_code}"
                                    error_msg="{compute_path_error_msg}"/>
                    <PublishGoals input_goals="{planning_goals}" topic_name= "truncated_goals"/>
                    <Delay delay_msec="1000">
                    <!-- Prevent replanning more frequent than 1 Hz. Delay used instead of Wait because it doesn't spam with logs -->
                      <AlwaysSuccess/>
                    </Delay>
                  </Sequence>
                </RetryUntilSuccessful>
                <!-- 
                <GetPoseFromPath path="{avoid_path}" index="-1" pose="{next_pose}"/>
                <SetBlackboard output_key="current_pose" value="{next_pose}"/>
                <TruncatePathLocal input_path="{path}" pose="{current_pose}" output_path="{path_local}" distance_forward="1.0" distance_backward="0.0" robot_frame="base_link"/>
                <ConcatenatePaths input_path1="{avoid_path}" input_path2="{path_local}" output_path="{path_local}"/>

                -->
                <GetPoseFromPath path="{avoid_path}" index="-1" pose="{next_pose}"/>
                <SetBlackboard output_key="current_pose" value="{next_pose}"/>
                <TruncatePathLocal input_path="{path}" pose="{current_pose}" output_path="{path_local}" distance_forward="1.0" distance_backward="0.0" robot_frame="base_link"/>
                <TruncatePathLocal input_path="{path}" pose="{current_pose}" output_path="{path}" distance_forward="100000000000.0" distance_backward="0.0" robot_frame="base_link"/>
                <ConcatenatePaths input_path1="{avoid_path}" input_path2="{path}" output_path="{path}"/>
                <ConcatenatePaths input_path1="{avoid_path}" input_path2="{path}" output_path="{path_local}"/>
                <SetBlackboard output_key="stopped" value="false"/>
              </Sequence>
            </Fallback>
          </ForceFailure>
        </RetryUntilSuccessful>
      </PipelineSequence>
    </Sequence>
  </BehaviorTree>
</root>





